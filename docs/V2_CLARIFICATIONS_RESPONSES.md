# V2 Architecture - Clarifications & Responses

**Date:** January 14, 2026  
**Document Version:** 1.0  
**Related Doc:** CLASS_ASSIGNMENT_V2_ARCHITECTURE.md

---

## üìù Summary of Changes & Answers

### 1. ‚úÖ Container Naming for Business Users

**Your Question:** Instead of containers, can we have a name which is suitable for business users to understand and relatable to them?

**Answer:**
- **UI/Business Term:** "**Program**" or "**Class Series**"
- **Technical Term (Code/DB):** "Container" (stays as-is for backward compatibility)
- **Usage:**
  - Business users see: "Programs" in UI
  - Developers use: `class_containers` table, `container_id` variables
  - Documentation uses both interchangeably with clarification

**Examples:**
- ‚úÖ UI: "Monthly Yoga Program with Sarah"
- ‚úÖ UI: "4-Week Crash Course"
- ‚úÖ Code: `class_container_id`, `ContainerService`

**Updated in Doc:**
- Navigation route: `/dashboard/programs-v2`
- Component names can stay as `ClassesDashboard` but display "Programs" in UI
- All user-facing text updated to use "Program" or "Class Series"

---

### 2. ‚úÖ Meeting Links Auto-Generation

**Your Question:** Meeting links will be autogenerated by pg_cron jobs calling required function before 12 hours of each class. For some cases admin/instructors can provide meeting URLs. Ok?

**Answer:** **Perfect! Confirmed.**

**Implementation:**
```sql
-- pg_cron job (already exists or needs to be created)
SELECT cron.schedule(
  'generate-zoom-links',
  '0 */1 * * *',  -- Every hour
  $$
  SELECT generate_zoom_meeting_links();
  $$
);

-- Function checks assignments 12 hours ahead
CREATE OR REPLACE FUNCTION generate_zoom_meeting_links()
RETURNS void AS $$
BEGIN
  UPDATE class_assignments
  SET zoom_meeting = generate_zoom_api_call(id)
  WHERE 
    zoom_meeting IS NULL  -- Only if not manually set
    AND date = CURRENT_DATE + INTERVAL '12 hours'
    AND class_status = 'scheduled';
END;
$$ LANGUAGE plpgsql;
```

**UI Behavior:**
- Admin/Instructor can manually enter meeting URL anytime
- If manual URL exists, pg_cron skips auto-generation
- Display in form: "Meeting URL will be auto-generated 12 hours before class (or enter manually)"

**Updated in Doc:** Section on Zoom meeting generation clarified

---

### 3. ‚úÖ Class Status - Add 'rescheduled'

**Your Question:** class_status should have "rescheduled" status

**Answer:** **Added!**

**Updated Enum:**
```sql
class_status (text) DEFAULT 'scheduled' 
-- Values: 'scheduled', 'completed', 'not_conducted', 'rescheduled'
```

**Usage:**
- When admin reschedules a class, set `class_status = 'rescheduled'`
- Link to new assignment via `rescheduled_to_id`
- Original assignment kept for audit trail

**Updated in Doc:** Database schema section updated with new status

---

### 4. ‚úÖ Container Creation from Class Packages

**Your Question:** Container should be created from Class packages (/dashboard/class_type_manager) which means container = instance of Classes or Packages. Tell me if we want to modify /dashboard/class_type_manager to suit the needs for this or existing should be ok.

**Answer:** **Existing Class Type Manager is PERFECT! No modifications needed.**

**How It Works:**

1. **Existing Class Type Manager:**
   - Already manages `class_packages` table ‚úÖ
   - Already has fields: `name`, `class_count`, `price`, `course_type` (regular/crash), `type` (Individual/Corporate/Private group) ‚úÖ
   - Fully functional - no changes needed ‚úÖ

2. **V2 Program Creation Flow:**
   ```
   Admin ‚Üí /dashboard/programs-v2 ‚Üí [+ Create Program]
     ‚Üì
   Modal Step 1: Select Package
     ‚Üì Dropdown loads from class_packages
     ‚Üì Shows: "Monthly 12-Class Individual (‚Çπ800)"
     ‚Üì
   Modal Step 2: Optional Instructor Selection
     ‚Üì
   Modal Step 3: Auto-set capacity based on package type
     ‚Üì
   Creates class_container record:
     - package_id: selected package
     - instructor_id: optional (can be null)
     - container_type: from package.type
     - max_booking_count: 1 for individual, else admin sets
     - display_name: "{package.name} - {instructor.name || 'Unassigned'}"
   ```

3. **Integration:**
   ```typescript
   // In V2 CreateProgramModal component
   const { data: packages } = await supabase
     .from('class_packages')
     .select('*')
     .eq('is_active', true)
     .order('name');
   
   // Dropdown in form
   <select onChange={handlePackageSelect}>
     {packages.map(pkg => (
       <option value={pkg.id}>
         {pkg.name} - {pkg.class_count} classes ({pkg.course_type})
       </option>
     ))}
   </select>
   ```

**No Changes Needed to Class Type Manager!** It's the source of truth for packages, V2 just consumes them.

**Updated in Doc:** Workflow 1 completely rewritten to show package-first creation

---

### 5. ‚úÖ Instructor Selection - Optional

**Your Question:** Instructor selection should not be mandatory. We can assign instructor later or change instructor as necessary.

**Answer:** **Implemented!**

**Changes:**
- `class_containers.instructor_id` can be `NULL`
- Display name format:
  - With instructor: "Monthly Yoga - Sarah Johnson"
  - Without: "Monthly Yoga (Unassigned)"
- Can be changed anytime via "Edit Program" modal

**Assignment Creation:**
- If program has instructor ‚Üí auto-filled in assignment form
- If program has no instructor ‚Üí admin MUST select instructor for assignment
- Validation: **Assignment requires instructor**, but **Program does not**

**Updated in Doc:** Validation rules and form specs updated

---

### 6. ‚úÖ Display Name - Include Instructor

**Your Question:** Display Name: Also add Instructor name in the name.

**Answer:** **Already planned and now clarified!**

**Format:**
```typescript
function generateDisplayName(package, instructor) {
  if (instructor) {
    return `${package.name} - ${instructor.full_name}`;
  } else {
    return `${package.name} (Unassigned)`;
  }
}

// Examples:
// "Monthly 12-Class Yoga - Sarah Johnson"
// "4-Week Crash Course - Mike Chen"
// "Weekly Group Yoga (Unassigned)"  // No instructor yet
```

**Editable:** Admin can override auto-generated name if needed

**Updated in Doc:** Display name generation clarified in workflow

---

### 7. ‚úÖ Manual vs Automatic Assignment

**Your Question:** Is Create Assignment manual? I think we can have manual assignment but automatic should also be there which is handled by t5. Tell me if I am wrong here.

**Answer:** **You're absolutely right! Both exist.**

**Two Methods:**

#### A. Manual Assignment (Admin UI)
- Admin clicks "+ Create Assignment" in program drawer
- Fills form: date, time, timezone, notes
- Creates single assignment on-demand
- Use case: Ad-hoc classes, makeup classes, crash courses

#### B. Automatic Assignment (pg_cron T-5)
- Runs 5 days before billing cycle
- Finds `bookings` with `is_recurring = true`
- Auto-generates next month's classes
- Uses `preferred_days` and `preferred_times` from booking
- Marks as `assignment_method = 'auto_distribute'`
- Use case: Regular monthly/recurring classes

**Assignment Method Field:**
```sql
assignment_method (text) DEFAULT 'manual'
-- Values: 
--   'manual' - Created by admin via UI
--   'weekly_recurrence' - Bulk created via recurrence tool
--   'auto_distribute' - Created by pg_cron T-5 automation
```

**Updated in Doc:** Workflow 2 now split into 2A (Manual) and 2B (Automatic)

---

### 8. ‚úÖ Crash Course Assignment

**Your Question:** There should be scope for crash courses assignment. If you are unsure check the /docs folder to understand how crash courses should be assigned.

**Answer:** **Confirmed and documented!**

**Crash Course Behavior (from BOOKING_TYPES_AND_WORKFLOWS.md):**

1. **Package Setup:**
   - `course_type = 'crash'`
   - `duration` field set (e.g., "4 weeks")
   - Fixed `class_count` (e.g., 12 sessions)

2. **Assignment Creation:**
   - ‚ùå **NO T-5 automation** (crash courses don't auto-renew)
   - ‚úÖ **All manual or bulk creation upfront**
   - Admin creates all 12 sessions at once via bulk tool or manually
   - All must be within `duration` timeframe

3. **Special Validation:**
   ```typescript
   // Crash course specific checks
   if (package.course_type === 'crash') {
     // Must create all assignments upfront
     // Must be within package.duration
     // No monthly accumulation
   }
   ```

4. **UI Support:**
   - Bulk assignment creation modal
   - Date range selector for crash course
   - Validation: all dates within course duration

**Updated in Doc:** Workflow 2 includes crash course handling

---

### 9. ‚úÖ How Bookings are Assigned

**Your Question:** I need to know how the Bookings are assigned. To the container or class assignments? How it is done from UI.

**Answer:** **Both! Via junction table `assignment_bookings`**

**Database Relationship:**
```
bookings (student enrollments)
    ‚Üì
assignment_bookings (junction table)
    ‚Üì
    ‚îú‚îÄ‚Üí class_container_id (program link)
    ‚îî‚îÄ‚Üí assignment_id (individual session link)
```

**From UI (Admin):**

#### Option 1: During Program Creation
```
Admin creates program
  ‚Üì
Modal has section: "Enroll Students"
  ‚Üì
Select existing bookings (dropdown)
  ‚Üì
System creates assignment_bookings entries:
  - Links booking to program (container_id)
  - Links booking to ALL future assignments in program
```

#### Option 2: After Program Creation
```
Admin opens program drawer
  ‚Üì
Clicks "Assign Students" button
  ‚Üì
Modal shows available bookings:
  - Filter by package match
  - Filter by instructor match
  - Search by student name
  ‚Üì
Select students to enroll
  ‚Üì
System creates assignment_bookings entries
  ‚Üì
Capacity counter updates
```

#### Option 3: Automatic (pg_cron T-5)
```
pg_cron runs
  ‚Üì
Finds bookings with matching:
  - package_id
  - instructor_id (if set)
  - is_recurring = true
  ‚Üì
Auto-links to existing program OR creates new program
  ‚Üì
Creates assignment_bookings entries for all new assignments
```

**Key Points:**
- One booking can link to MANY assignments (all sessions in program)
- One assignment can link to MANY bookings (group classes)
- Capacity = COUNT(DISTINCT booking_id per program)
- Only 'confirmed' bookings count toward capacity

**Updated in Doc:** New Workflow 2B section added explaining booking assignment

---

### 10. ‚úÖ T-5 Automation is pg_cron

**Your Question:** T-5 automation runs (GitHub Actions cron) - I think it is pg-cron

**Answer:** **You're correct! It's pg_cron.**

**Current Setup:**
```sql
-- From: supabase/migrations/20250102000000_schedule_all_cron_jobs.sql

SELECT cron.schedule(
  't5-invoice-generation',
  '0 0 * * *',  -- Daily at midnight
  $$
  SELECT generate_t5_invoices();
  $$
);
```

**What T-5 Does:**
1. Runs daily via pg_cron extension (in Supabase)
2. Checks bookings 5 days before next billing cycle
3. Generates invoices for next month
4. Creates class assignments for next month
5. Links assignments to bookings

**NOT GitHub Actions** - it's a database-level scheduled job.

**Updated in Doc:** All references to "GitHub Actions cron" changed to "pg_cron"

---

### 11. ‚úÖ Timezone Handling for Instructor Conflicts

**Your Question:** Will this tackle multiple timezone assignment? If not then after instructor assignments, we can have instructor schedules in a fixed timezone in the db for easy reference. Check db schema if needed.

**Answer:** **Great suggestion! Schema already supports this.**

**Existing Table:**
```sql
instructor_availability
‚îú‚îÄ‚îÄ id
‚îú‚îÄ‚îÄ instructor_id
‚îú‚îÄ‚îÄ day_of_week (0-6, Sunday=0)
‚îú‚îÄ‚îÄ start_time (time without time zone)
‚îú‚îÄ‚îÄ end_time (time without time zone)
‚îú‚îÄ‚îÄ timezone (IMPLICIT - should store instructor's preferred timezone)
```

**Enhanced Conflict Check:**
```typescript
async function checkInstructorConflict(
  instructorId: string,
  date: string,
  startTime: string,
  endTime: string,
  timezone: string = 'Asia/Kolkata'
) {
  // Step 1: Get instructor's preferred timezone
  const { data: instructorTz } = await supabase
    .from('instructor_availability')
    .select('*')
    .eq('instructor_id', instructorId)
    .limit(1)
    .single();
  
  const preferredTz = instructorTz?.timezone || 'Asia/Kolkata';
  
  // Step 2: Convert input times to instructor's timezone
  const normalizedStart = convertToTimezone(startTime, timezone, preferredTz);
  const normalizedEnd = convertToTimezone(endTime, timezone, preferredTz);
  
  // Step 3: Check conflicts in unified timezone
  const { data: conflicts } = await supabase
    .from('class_assignments')
    .select('*')
    .eq('instructor_id', instructorId)
    .eq('date', date);
  
  // Step 4: Compare times in instructor's timezone
  return conflicts.some(existing => {
    const existingStart = convertToTimezone(
      existing.start_time, 
      existing.timezone || 'Asia/Kolkata',
      preferredTz
    );
    // ... overlap check
  });
}
```

**Benefits:**
- Instructor sets preferred timezone once in availability
- All comparisons done in instructor's timezone
- Supports global instructors (India, US, Europe)
- Prevents scheduling conflicts across timezones

**Recommendation:** Add `timezone` field to `instructor_availability` table (migration) OR store in instructor profile preferences.

**Updated in Doc:** Conflict check function updated with timezone conversion logic

---

## üìã Summary of Document Updates

‚úÖ **Terminology:** Container ‚Üí Program (UI), Container (code)  
‚úÖ **Navigation:** `/dashboard/programs-v2`  
‚úÖ **Package Integration:** Programs created from Class Type Manager packages  
‚úÖ **Instructor:** Optional at program level, required at assignment level  
‚úÖ **Display Name:** Includes instructor name when assigned  
‚úÖ **Assignments:** Both manual (UI) and automatic (pg_cron)  
‚úÖ **Crash Courses:** Manual only, no T-5 automation, all upfront  
‚úÖ **Bookings:** Assigned via `assignment_bookings` junction table  
‚úÖ **Meeting Links:** Auto-generated by pg_cron 12hrs before, manual override allowed  
‚úÖ **Class Status:** Added 'rescheduled' to enum  
‚úÖ **Automation:** Confirmed pg_cron (not GitHub Actions)  
‚úÖ **Timezones:** Instructor-centric timezone handling for conflict checks  

---

## üéØ Next Steps

1. ‚úÖ Review updated CLASS_ASSIGNMENT_V2_ARCHITECTURE.md
2. ‚è≥ Confirm all clarifications address your concerns
3. ‚è≥ Approve architecture for implementation
4. ‚è≥ Begin Phase 1: Foundation (Week 1)

---

**Questions? Review the updated architecture doc and let me know if anything needs further clarification!**
